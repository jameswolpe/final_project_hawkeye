---
title: "Untitled"
author: "James Wolpe"
date: "3/25/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(lubridate)
```

# Notes on Coding

## Serves
Direction: 4 = out wide, 5 = body, and 6 = down the T.

## Rally Sequence
f = forehand
b = backhand

r = forehand slice (including defensive chips, but not drop shots)
s = backhand slice (including defensive chips, but not drop shots)

## Direction
1 = to a right-hander's forehand side
2 = down the middle of the court (middle 40% of the court)
3 = to a right-hander's backhand side

## Exceptions (For now deleting if any occur)
### Serves
+ is used for serve and volley
* is used for ace serves
# is used for unreturnable serves (same as forced error)
@ is used for unforced errors
0 is used on serve if the location is not known
c is used for let serves

### Rally sequence
v = forehand volley
z = backhand volley
(see below for an optional additional code to indicate a stop volley/drop volley)

o = standard overhead/smash
p = "backhand" overhead/smash

u = forehand drop shot
y = backhand drop shot

l = forehand lob
m = backhand lob

h = forehand half-volley
i = backhand half-volley

j = forehand swinging volley
k = backhand swinging volley

t = all trick shots, including behind-the-back, between-the-legs, and "tweeners."

q = any unknown shot

### Direction
0 = unknown direction

```{r}
# read in the full data set
points_data <- read_csv("data/charting-m-points.csv")
match_data <- read_csv("data/charting-m-matches.csv")
combined_left <- left_join(points_data, match_data, by = c("match_id" = "match_id"))
# merge to get players height in the data set
atp_players <- read_csv("data/atp_players.csv")
# Will have to unite the players in this data set by first and last name and either only look at the winner of each match or pivot longer (code from the atp shiny app) to compare height of players over the years.
```


```{r}
NK_NB_match_data<- combined_left %>% 
  # making the data set easier to work with by only selecting one match
  filter(match_id == "20220310-M-Indian_Wells_Masters-R128-Sebastian_Baez-Nick_Kyrgios") 

NK_NB_match_data2 <- NK_NB_match_data %>% 
  select(c( Pt, `1st`, `2nd`, `2ndSV`,isForced, isUnforced, PtWinner, rallyCount, match_id, isAce, isDouble, Svr, Ret, Serving,)) 

NK_NB_match_data2 <- NK_NB_match_data %>%
  rename(FirstServe = `1st`,
         SecondServe = `2nd`,
         SecondServeTF = `2ndSV`) 

# Get the right columns
NK_NB_match_data3 <- NK_NB_match_data2 %>%
  mutate(Point = if_else(is.na(SecondServeTF), 
          true = FirstServe,
          false = NA_character_)) %>% 
  unite(points, Point, SecondServe, na.rm = TRUE) %>% 
  select(-FirstServe, -SecondServeTF)

# Filter Aces, double faults, and forced errors off the first serve
 NK_NB_match_data4 <- NK_NB_match_data3 %>% 
  filter(isAce == FALSE,
         isDouble == FALSE) %>%
  select(-isDouble, -isAce)
   
 NK_NB_match_data5 <-  NK_NB_match_data4 %>%
   #Need an and and an or to keep rally count > 1 and forced is false
  filter(rallyCount != 1 | rallyCount == 1 & isForced == FALSE) 

  #filter points with unknown shots
  # Filtered any serves with unknown direction
 # Filter points that don;t have direction and depth a number followed by two digits.
 # filter volleys(v,z), smashes(o,p), swinging volleys(i,k), net cords(;), and approach shots(+), serve shanks(!)
NK_NB_match_data6 <- NK_NB_match_data5 %>%
  filter(str_detect(string = points, pattern = "^[456][456(?=[:alpha:]?={2}[:digit:])]"))

NK_NB_match_data6 <- NK_NB_match_data6 %>%
  filter(str_detect(string = points, pattern ="([:symbol:])") == FALSE,
         str_detect(string = points, pattern ="[vzopik;t!]") == FALSE)
```


```{r}
# classify a shot as a character followed by a digit
shot <- "([:alpha:]?=[:digit:]+)"

source("~/Downloads/james_strings.R")

vals <- strsplit_keep(NK_NB_match_data6$points, "[fbrsvzopuylmhijkt]", type = "before")
vals1 <- map_df(vals, ~data.frame(value = .x), .id = "id")


merge1 <- vals1 %>% group_by(id) %>%
  mutate(shot_num = row_number())

merge2 <- merge1 %>% pivot_wider(names_from = shot_num,
                       values_from = value)

plength <- ncol(merge2)

merge3 <- bind_cols(merge2, NK_NB_match_data6) %>%
  pivot_longer(cols = c(2:all_of(plength)),
               names_to = "shot_in_seq",
               values_to = "shot") %>%
  filter(!is.na(shot))

merge3$shot_in_seq <- as.numeric(merge3$shot_in_seq)
```


```{r}
merge3 <- merge3 %>% mutate(player = if_else(shot_in_seq %% 2 == 1,
                                             true = `Player 1`,
                                             false = `Player 2`))
# create previous shot variable
merge3 <- merge3 %>% mutate(shot_after = lead(shot)) 
# create ultimate shot and penultimate shot variable
merge3 <- merge3 %>% mutate(ultimate_shot = if_else(is.na(shot_after),
          true = TRUE,
          false = FALSE)) %>%
  mutate(penultimate_shot = lead(ultimate_shot))

#Create stroke and direction variable
merge3 <- separate(data = merge3,
                   col = shot,
                   into = c("stroke", "direction"),
                   sep=1) 
# Create depth variable
merge3 <- separate(data = merge3,
                   col = direction,
                   into = c("direction","depth"),
                   sep=1) 
#Create stroke and direction variable for shot_after
merge3 <- separate(data = merge3,
                   col = shot_after,
                   into = c("stroke_after", "direction_after"),
                   sep=1) 

# Create depth variable for shot_after
merge3 <- separate(data = merge3,
                   col = direction_after,
                   into = c("direction_after","depth_after"),
                   sep=1)
# Make blank Cells NA
merge3 <- merge3 %>% mutate_all(na_if,"")
```


```{r}
merge3sum <- merge3 %>% filter(player == "Nick Kyrgios",
                               stroke == "f",
                               direction == 1) %>% 
  group_by(direction_after) %>%
  summarise(count = n())
```

```{r}
write.csv(classifying_directionals.Rmd, "classifying_directionals.csv")
```

